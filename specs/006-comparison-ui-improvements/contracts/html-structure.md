# HTML Structure Contract: Multi-Environment Comparison Report

**Feature**: 006-comparison-ui-improvements  
**Date**: January 15, 2026  
**Version**: 2.0  
**Purpose**: Define the HTML structure contract for multi-environment comparison reports

---

## Overview

This document defines the HTML structure that `multi_env_comparator.py` MUST generate and that browsers MUST render correctly. This contract ensures backward compatibility while introducing new UI improvements (attribute headers, scrollable containers, environment-specific resource grouping).

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-01-05 | Initial table-based attribute layout (spec 001) |
| 2.0 | 2026-01-15 | Section-based attribute layout with scrollable containers (spec 006) |

---

## Document Structure

### Root HTML Template

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Environment Terraform Plan Comparison</title>
    <style>
        /* Inline CSS from html_generation.generate_full_styles() */
    </style>
</head>
<body>
    <div class="container">
        <h1>Multi-Environment Terraform Plan Comparison</h1>
        
        <!-- Summary Cards Section -->
        <div class="summary-cards">...</div>
        
        <!-- Main Comparison Section -->
        <div class="comparison-section">
            <!-- Regular resources with cross-env differences -->
        </div>
        
        <!-- Environment-Specific Resources Section -->
        <details open class="env-specific-section">
            <!-- Resources in only some environments -->
        </details>
    </div>
</body>
</html>
```

**Contract Requirements**:
- MUST include viewport meta tag for responsive rendering
- MUST use inline CSS (no external stylesheets)
- MUST have single root `.container` div
- CSS MUST be generated by `html_generation.generate_full_styles()`

---

## Summary Cards Section

```html
<div class="summary-cards">
    <div class="summary-card total">
        <div class="label">Total Resources</div>
        <div class="number">199</div>
    </div>
    <div class="summary-card">
        <div class="label">Resources with Differences</div>
        <div class="number">196</div>
    </div>
    <div class="summary-card">
        <div class="label">Identical Resources</div>
        <div class="number">3</div>
    </div>
</div>
```

**Contract Requirements**:
- MUST display at least total resource count
- MAY include additional metrics (differences, identical, env-specific)
- Cards MUST use `.summary-card` class
- Numbers MUST use `.number` class

---

## Resource Card Structure (v2.0 - Section-Based Layout)

### Regular Resource (Present in Multiple Environments)

```html
<div class="resource-card">
    <div class="resource-header">
        <h2 class="resource-name">
            <span class="resource-type-badge">[resource_type]</span>
            <code>resource_name</code>
        </h2>
    </div>
    
    <div class="resource-body">
        <!-- Sticky environment headers (v2.0) -->
        <div class="env-headers">
            <div class="env-header sticky-header">Test</div>
            <div class="env-header sticky-header">Production</div>
        </div>
        
        <!-- Attribute sections (v2.0) -->
        <div class="attribute-section">
            <h3 class="attribute-header">
                <code>attribute_name</code>
                <span class="sensitive-badge">üîí SENSITIVE</span> <!-- if sensitive -->
            </h3>
            <div class="attribute-values">
                <div class="env-value-column">
                    <div class="env-label">Test</div>
                    <div class="value-container">
                        <!-- Value content with diff highlighting -->
                        <span class="baseline-removed">old value</span>
                    </div>
                </div>
                <div class="env-value-column">
                    <div class="env-label">Production</div>
                    <div class="value-container">
                        <!-- Value content with diff highlighting -->
                        <span class="baseline-added">new value</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Additional attribute sections... -->
    </div>
</div>
```

**Contract Requirements**:
- Each resource MUST be wrapped in `.resource-card` div
- Resource header MUST include `.resource-type-badge` and resource name in `<code>`
- Resource body MUST contain `.env-headers` with sticky headers (v2.0)
- Each attribute MUST be wrapped in `.attribute-section` div (v2.0 change)
- Attribute name MUST be `<h3>` with `.attribute-header` class (v2.0 change)
- Attribute values MUST be in `.attribute-values` flex container (v2.0 change)
- Each environment value MUST be in `.env-value-column` (v2.0 change)
- Each value MUST be wrapped in `.value-container` with scrollbar support (v2.0 change)

---

## Environment-Specific Resource Section (v2.0 - NEW)

```html
<details open class="env-specific-section">
    <summary class="env-specific-header">
        <strong>‚ö†Ô∏è Environment-Specific Resources</strong>
        <span class="resource-count">(5 resources)</span>
    </summary>
    <div class="env-specific-content">
        <!-- Resource cards for env-specific resources -->
        <div class="resource-card">
            <div class="resource-header">
                <h2 class="resource-name">
                    <span class="resource-type-badge">[type]</span>
                    <code>resource_name</code>
                    <span class="env-specific-badge">‚ö†Ô∏è Test only</span>
                </h2>
            </div>
            <div class="resource-body">
                <div class="presence-info">
                    <strong>Present in:</strong> Test<br>
                    <strong>Missing from:</strong> Production, Staging
                </div>
                <!-- Attribute sections only for environments where resource exists -->
            </div>
        </div>
    </div>
</details>
```

**Contract Requirements** (v2.0):
- Section MUST use HTML5 `<details>` and `<summary>` elements
- MUST default to expanded state (`<details open>`)
- MUST use `.env-specific-section` class
- Summary MUST show warning icon (‚ö†Ô∏è) and resource count
- Each env-specific resource card MUST include `.env-specific-badge` in header
- Badge text MUST follow pattern: "{Environment} only" or "Present in: {envs}"
- Resource body MUST include `.presence-info` div showing which environments contain the resource
- MUST only show attributes for environments where resource exists (no empty cells)

---

## Value Container Constraints (v2.0 - NEW)

### Scrollable Value Container

```html
<div class="value-container">
    <!-- Primitive value -->
    <span class="baseline-removed">"old_string_value"</span>
    
    <!-- OR Complex value (JSON object/array) -->
    <pre class="json-value">
{
  <span class="baseline-char-removed">"key": "old_value"</span>
}
    </pre>
</div>
```

**CSS Contract**:
```css
.value-container {
    max-height: 400px;      /* FR-004 */
    max-width: 600px;       /* FR-005 */
    overflow: auto;         /* FR-003, FR-010 */
    padding: 10px;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    background: white;
}
```

**Behavior Contract**:
- Scrollbars MUST only appear when content exceeds max dimensions (auto behavior)
- Multiple value containers on same page MUST have independent scroll states
- Diff highlighting classes MUST be preserved within value container (FR-011)
- Container MUST NOT affect page layout when content is large

---

## Sticky Header Constraints (v2.0 - NEW)

### Environment Column Headers

```html
<div class="env-headers">
    <div class="env-header sticky-header">Test</div>
    <div class="env-header sticky-header">Production</div>
</div>
```

**CSS Contract**:
```css
.sticky-header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #f8f9fa;  /* Opaque background required */
    border-bottom: 2px solid #dee2e6;
    padding: 12px;
}
```

**Behavior Contract** (FR-013):
- Headers MUST stick to top of viewport when scrolling vertically
- Headers MUST have opaque background to prevent content showing through
- Only environment column headers stick (not attribute headers)
- Z-index MUST be high enough to appear above scrollable content

---

## Diff Highlighting Classes (Preserved from v1.0)

All existing diff highlighting classes MUST continue to work within new value containers:

| Class | Background | Text Color | Usage |
|-------|------------|------------|-------|
| `.baseline-removed` | `#bbdefb` | `#0d47a1` | Baseline environment value being compared from |
| `.baseline-char-removed` | `#90caf9` | `#01579b` | Character-level removed in baseline |
| `.baseline-added` | `#c8e6c9` | `#1b5e20` | Comparison environment value changing to |
| `.baseline-char-added` | `#81c784` | `#2e7d32` | Character-level added in comparison |
| `.char-removed` | `#ff9999` | `#7d0000` | Non-baseline character removed |
| `.char-added` | `#99ff99` | `#006600` | Non-baseline character added |
| `.known-after-apply` | `#ffe8a1` | `#995700` | Value known only after apply |

**Contract Requirements**:
- ALL existing diff classes MUST continue to function
- Classes MUST work inside `.value-container` divs
- Nested highlighting (line + character level) MUST be preserved

---

## Backward Compatibility

### v1.0 ‚Üí v2.0 Migration

**Breaking Changes**:
- Attribute layout changed from table-based to section-based
- Environment headers now sticky (new behavior)
- Value containers now scrollable (new behavior)

**Preserved**:
- Summary cards structure unchanged
- Resource card outer structure unchanged
- Diff highlighting classes unchanged
- CSS color palette unchanged
- No JavaScript still required

**Migration Impact**:
- Existing tests MUST be updated to expect new HTML structure
- CSS selectors in tests MUST be updated (`.attribute-table` ‚Üí `.attribute-section`)
- Diff highlighting assertions remain valid (classes unchanged)

---

## Browser Compatibility Contract

Generated HTML MUST render correctly in:
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

**Required Features**:
- CSS `position: sticky` support
- CSS Flexbox support
- CSS `overflow: auto` support
- HTML5 `<details>` and `<summary>` support

All target browsers support these features ‚úÖ

---

## Accessibility Contract

Generated HTML MUST be accessible:
- All semantic HTML elements used correctly (`<h1>`, `<h2>`, `<h3>`, `<details>`, `<summary>`)
- Color contrast ratios MUST meet WCAG AA standards (4.5:1 minimum)
- Keyboard navigation MUST work for collapsible sections (Space/Enter)
- Screen readers MUST announce expanded/collapsed state of `<details>`
- Code blocks MUST use `<code>` tags for resource names and attribute names
- No information conveyed by color alone (icons and text labels required)

---

## Test Validation Contract

### HTML Structure Tests

Tests MUST validate:
1. `.resource-card` exists for each resource
2. `.attribute-section` exists for each attribute (v2.0)
3. `.attribute-header` is `<h3>` element (v2.0)
4. `.value-container` exists for each environment value (v2.0)
5. `.sticky-header` exists for environment headers (v2.0)
6. `.env-specific-section` exists when environment-specific resources present (v2.0)
7. `<details open>` default state for env-specific section (v2.0)

### CSS Tests

Tests MUST validate:
1. `.value-container` has `max-height: 400px` and `overflow: auto`
2. `.sticky-header` has `position: sticky` and `top: 0`
3. All diff highlighting classes present in CSS output
4. Color contrast ratios meet WCAG AA standards

### End-to-End Tests

Tests MUST validate:
1. CLI command `tf-plan-analyzer compare --html` generates valid HTML
2. Generated HTML opens in browser without errors
3. Scrollbars appear only when content exceeds container size
4. Sticky headers remain visible when scrolling vertically
5. Collapsible section can be toggled via keyboard

---

## Example: Complete Resource Card (v2.0)

```html
<div class="resource-card">
    <div class="resource-header">
        <h2 class="resource-name">
            <span class="resource-type-badge">azurerm_storage_account</span>
            <code>mystorageaccount</code>
        </h2>
    </div>
    
    <div class="resource-body">
        <!-- Sticky environment headers -->
        <div class="env-headers">
            <div class="env-header sticky-header">Test</div>
            <div class="env-header sticky-header">Production</div>
        </div>
        
        <!-- Attribute: account_tier -->
        <div class="attribute-section">
            <h3 class="attribute-header"><code>account_tier</code></h3>
            <div class="attribute-values">
                <div class="env-value-column">
                    <div class="env-label">Test</div>
                    <div class="value-container">
                        <span class="baseline-removed">"Standard"</span>
                    </div>
                </div>
                <div class="env-value-column">
                    <div class="env-label">Production</div>
                    <div class="value-container">
                        <span class="baseline-added">"Premium"</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Attribute: network_rules (complex object) -->
        <div class="attribute-section">
            <h3 class="attribute-header">
                <code>network_rules</code>
                <span class="sensitive-badge">üîí SENSITIVE</span>
            </h3>
            <div class="attribute-values">
                <div class="env-value-column">
                    <div class="env-label">Test</div>
                    <div class="value-container">
                        <pre class="json-value">{
  "default_action": "Deny",
  "ip_rules": [
    <span class="baseline-char-removed">"10.0.0.0/24"</span>
  ]
}</pre>
                    </div>
                </div>
                <div class="env-value-column">
                    <div class="env-label">Production</div>
                    <div class="value-container">
                        <pre class="json-value">{
  "default_action": "Deny",
  "ip_rules": [
    <span class="baseline-char-added">"10.1.0.0/24"</span>
  ]
}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
```

This contract defines the MUST-HAVE structure for v2.0 multi-environment comparison reports.
